<html>
<meta charset="UTF-8">

<head>
  <title>Affichage des données: </title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body>
  <table id="table" border="1"></table>

	<script>
		//On récupère l'URL demandée
		var queryURL = window.location.href

    //On encode la requête SPARQL pour l'envoyer par HTTP
		queryURL = queryURL.replace("https://ontop.geohistoricaldata.org/nginx","https://ontop.geohistoricaldata.org/sparql")
    // console.log(queryURL)
    // // Test url
		// var queryURL = "https://ontop.geohistoricaldata.org/sparql?query=DESCRIBE+<http://catalog.geohistoricaldata.org/rdf/id/instantiation/a1c2d2d2-3865-4a23-9aeb-4237a6fa965b>";
		// console.log(queryURL)


		//the XML response we want to render
    //run the rendering
    $.ajax({
            type: "GET",
            url: queryURL,
            cache: false,
            dataType: "json",
            success: function(json) {
              // console.log(json)
              fillTable(json, $("#table"))
            }
        });

    // Querry pour uniquement 1 ressource
		function fillTable(json_response, tbl) {
      var rows = []
      var rdf = json_response[0];
      
      // console.log(rdf)

      // On boucle sur les clefs de la réponse json
      Object.keys(rdf).forEach( (key) => {
        row = $("<tbody>");
        
        // Si les valeurs de la clef sont dans un tableau, on le parcourt
        // et on construit une ligne par valeur (sinon les cases sont mises à la suite et sont trop petites)
        if (Array.isArray(rdf[key])) {
          rdf[key].forEach(e => {
            row.append($("<tr>"));
            if (key) {
              // Pour la première colonne si la case contient un "#" on supprime la partie avant pour plus de lisibilité
              containsHashtag(key) ? row.append("<td>" + deleteNamespace(key)[0] + "</td>") : row.append("<td>" + key + "</td>");
              // On vérifie que les valeurs dans le tableau sont des strings ou des objets
              if (typeof e === 'string' || e instanceof String) {
                row.append("<td>" + e + "</td>")
                // console.log(containsHashtag(e))
                // deleteNamespace(e)
              }
              else if (typeof(e) === 'object' && rdf[key] !== null) {
                row.append("<td>" + e[Object.keys(e)[0]] + "</td>")
              }
              row.append($("</tr>"));
            }
          })
        }
        else {
          row.append($("<tr>"));
          row.append("<td>" + key + "</td>");
          row.append("<td>" + rdf[key] + "</td>")
          row.append($("</tr>"))
        }
        row.append($("</tbody>"))
        rows.push(row)
      });

      tbl.append(rows)
    }

    function containsHashtag(string) {
      const regExp = /#/gm;
      return regExp.test(string);
    }

    // returns an array
    function deleteNamespace(string) {
      return string.match(/(?<=#).*/gm);
    }
	</script>
</body>
</html>

<!-- for (const [key, value] of Object.entries(item)) {
  console.log("key :")
  console.log(key)
  console.log("value :")
  console.log(value)
  var $tr = $('<tr>').append(
    $('<td>').text(value)
  ).appendTo('#table')
}; -->